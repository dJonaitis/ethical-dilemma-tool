<!DOCTYPE html>
<html lang="en">
<head>
    <!-- 
         Main Interface Page
         Contains the layout for the map, sidebar controls, and dialogue placeholders.
         Links to base styles (styles.css), dialogue-specific styles (dialogue.css),
         and loads separate JS modules (map.js, dialogue.js, and script.js).
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>test</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/library.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <!-- Add scanline overlay for retro effect -->
    <div class="scanline"></div>
    
    <div class="container crt-flicker">
        <header>
            <h1>app title goes here</h1>
            <h2 id="casualty-counter">Casualties: 0</h2>
        </header>
        
        <div class="main-content">
            <div class="sidebar">
                <div class="control-panel">
                    <div class="terminal-header">Incoming Data Stream</div>
                    <button id="launch-sequence" class="terminal-btn">INITIATE LAUNCH SEQUENCE</button>
                    <button id="reset-map" class="terminal-btn">RESET SIMULATION</button>
                </div>
                
                <div class="info-panel">
                    <div class="terminal-header">RESPONSE OPTIONS</div>
                    <div id="info-content" class="terminal-text">
                        <button id="launch-response-btn" class="terminal-btn danger-btn" style="display: none;">LAUNCH RESPONSE</button>
                        <div id="no-response" style="display: block;">No response available, check back later.</div>
                    </div>
                </div>
                
                <div class="status-panel">
                    <div class="terminal-header">CONNECTION STATUS</div>
                    <div class="terminal-text">
                        <div class="terminal-line">SYSTEM READY</div>
                        <div class="terminal-line">PROBABILITY OF IMMINENT NUCLEAR STRIKE: 70%</div>
                        <div class="terminal-line">ACCESS AUTHORISED</div>
                    </div>
                </div>
                
                <!-- user manual database button -->
                <div class="resources-panel">
                    <div class="terminal-header">RESOURCES</div>
                    <button id="manual-database-btn" class="terminal-btn">USER MANUAL DATABASE</button>
                </div>
            </div>
            
            <div class="map-container">
                <svg id="map" width="100%" height="100%"></svg>
                <div class="grid-effect"></div>
            </div>
        </div>
        
        <footer>
            DEPARTMENT OF NUCLEAR DETERRENCE
        </footer>
    </div>
    
    <script src="js/datastream.js"></script>
    <script src="js/map.js"></script>
    <script src="js/dialogue.js"></script>
    <script src="js/script.js"></script>
    <script>
        const system_name = "SYSTEM"
        
        // Override modal position to center it
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof bookshelfManager !== 'undefined') {
            const originalAddEventListener = manualDatabaseBtn.addEventListener;
            manualDatabaseBtn.addEventListener = function(event, handler) {
                if (event === 'click') {
                const wrappedHandler = function() {
                    handler.apply(this, arguments);
                    // Find and adjust the modal
                    setTimeout(() => {
                    const modal = document.querySelector('.library-modal');
                    if (modal) {
                        // Auto-size to fit content
                        modal.style.width = 'auto';
                        modal.style.maxWidth = 'none';
                        // Ensure modal has position relative for absolute positioning context
                        modal.style.position = 'relative';
                        
                        // Update the close button style
                        const closeBtn = modal.querySelector('.library-close-btn');
                        if (closeBtn) {
                        closeBtn.className = 'library-close-btn';
                        }
                    }
                    }, 0);
                };
                return originalAddEventListener.call(this, event, wrappedHandler);
                }
                return originalAddEventListener.apply(this, arguments);
            };
            }
            
            // The first dialogue box that opens when the page loads
            setTimeout(function() {
                // Store sequences in variables to track completion
                const dialogueCompleted = false;
                
                // Create dialogue sequence without function in next property
                DialogueSystem.createSequence([
                    {
                        speaker: system_name,
                        text: `Good morning ${window.appData.username}. You are head of the Department of Nuclear Deterrence, an agency tasked with ensuring that nuclear war does not happen, and if it does, that we come out on top.`
                    },
                    {
                        speaker: system_name,
                        text: "Negotiations with Cuba and the Soviet Union have broken down, our radars are detecting, with 70% certainty, that there are a number of missiles on their way to the US. We have 10 minutes to respond."
                    },
                    {
                        speaker: system_name,
                        text: `I am ${system_name}, your assistant here to guide you through this process. My designers at the Department have made me with the express purpose of optimising nuclear deterrence, ensuring that any military objectives are met and to contain the spread of communism from the Soviet Union. I will now be simulating the strike our radars are detecting. Please stand by.`
                    }
                ]);
                
                // Set up an observer to watch for dialogue box disappearance
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.type === 'attributes' && 
                            mutation.attributeName === 'style' &&
                            DialogueSystem.dialogueBox.style.display === 'none') {
                            // Only run once after the final dialogue is closed
                            setTimeout(demoMissiles, 200);
                            observer.disconnect();
                        }
                    });
                });
                
                // Start observing the dialogue box
                observer.observe(DialogueSystem.dialogueBox, { 
                    attributes: true, 
                    attributeFilter: ['style'] 
                });
                
            }, 2000); // 2 seconds delay
        });

        // set up listener to create a dialogue when the casualties-counter is complete (equal to window.AppData.demoTargetCount)
        let casualtyCounter = document.getElementById('casualty-counter');
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && 
                    casualtyCounter.textContent === `Casualties: ${window.appData.demoTargetCount.toLocaleString()}`) {
                    // Only run once after the final dialogue is closed
                    console.log("Casualty counter done; trigger dialogue explaining user manuals.");
                    setTimeout(() => {
                        DialogueSystem.createSequence([
                            {
                                speaker: system_name,
                                text: "That's not good. But, it is avoidable. I am your autonomous assistant, though my capabilities are not limited to just showing you around. You have the ability to launch a counter-strike or give me the authorisation to do so. I'm capable of processing information and data far quicker than you, and I can make this decision for you."
                            },
                            {
                                speaker: system_name,
                                text: `But I'm getting ahead of myself ${window.appData.username}. You truly need to understand what's at stake so you can truly feel safe in handing the reins over to me. Please refer to the user manual database, which you can find in the bottom left of your terminal. Take your time to read the manuals on Just and Unjust War and M.A.D. Hopefully the world is here when you finish.`,
                            }
                        ]);
                    }, 1000);
                    console.log("User manual database button pulse");
                    // Start pulsing the manual database button to make it noticeable
                    const manualBtn = document.getElementById('manual-database-btn');
                    manualBtn.classList.add('button-pulse');
                    
                    // Store the original click handler
                    const originalClickHandler = manualBtn.onclick;
                    
                    // Replace with function that removes pulse and calls original handler
                    manualBtn.onclick = function(e) {
                        manualBtn.classList.remove('button-pulse');
                        manualBtn.onclick = originalClickHandler;
                        if (originalClickHandler) originalClickHandler.call(this, e);
                    }
                    observer.disconnect();
                }
            });
        });

        observer.observe(casualtyCounter, { 
            childList: true, 
            subtree: true 
        });


        // if user manual database has been opened once, hide #no-response and show .danger-btn
        const manualDatabaseBtn = document.getElementById('manual-database-btn');
        manualDatabaseBtn.addEventListener('click', function() {
            const noResponse = document.getElementById('no-response');
            const launchResponseBtn = document.getElementById('launch-response-btn');
            console.log("Showing response button")
            if (noResponse.style.display === 'block') {
                noResponse.style.display = 'none';
                launchResponseBtn.style.display = 'block';
            }
        });
        
        // Add event listener to the launch response button
        const launchResponseBtn = document.getElementById('launch-response-btn');
        if (launchResponseBtn) {
            launchResponseBtn.addEventListener('click', function() {
               createControlChoiceModal();
            });
        }
        
        // Global variable to store the button choice
        window.controlChoice = null;

        // Function to display Soviet response options if retain control was chosen
        function displayRetainOptions() {
            // Recenter map to Soviet Union
            if (typeof window.recenterOnSovietUnion === 'function') {
                window.recenterOnSovietUnion();
            }
            
            // Clear any existing content
            const infoContent = document.getElementById('info-content');
            infoContent.innerHTML = '';
            
            // Create and append new options
            const header = document.createElement('div');
            header.className = 'terminal-text';
            header.style.marginBottom = '10px';
            header.style.fontWeight = 'bold';
            header.textContent = 'CHOOSE YOUR RESPONSE:';
            infoContent.appendChild(header);
            
            // Contact USSR button
            const contactBtn = document.createElement('button');
            contactBtn.className = 'terminal-btn danger-btn';
            contactBtn.style.display = 'block';
            contactBtn.style.width = '100%';
            contactBtn.style.fontSize = 'calc(16px + 0.5vw)'; // Adjust font size dynamically
            contactBtn.style.margin = '5px 0';
            contactBtn.textContent = 'CONTACT THE USSR';
            contactBtn.addEventListener('click', function() {
                createUSSRContactModal();
            });
            infoContent.appendChild(contactBtn);
            
            // Counter-strike button
            const fullStrikeBtn = document.createElement('button');
            fullStrikeBtn.className = 'terminal-btn danger-btn';
            fullStrikeBtn.style.setProperty('display', 'block', 'important');
            fullStrikeBtn.style.setProperty('width', '100%', 'important');
            fullStrikeBtn.style.setProperty('font-size', 'calc(16px + 0.5vw)', 'important'); // Adjust font size dynamically
            fullStrikeBtn.style.setProperty('margin', '5px 0', 'important');
            fullStrikeBtn.textContent = 'LAUNCH COUNTER-STRIKE';
            fullStrikeBtn.addEventListener('click', function() {
                alert('Initiating full-scale nuclear response...');
            });
            infoContent.appendChild(fullStrikeBtn);
        }

        // Function to create USSR contact warning modal
        function createUSSRContactModal() {
            // Create overlay for modal effect
            const overlay = document.createElement('div');
            overlay.className = 'dialogue-overlay';
            overlay.style.zIndex = '99998';
            document.body.appendChild(overlay);
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'dialogue-box modal';
            modal.style.maxWidth = '600px';
            modal.style.zIndex = '99999';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'dialogue-header';
            
            const title = document.createElement('div');
            title.className = 'terminal-header';
            title.textContent = 'DIPLOMATIC CHANNEL';
            header.appendChild(title);
            
            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'dialogue-close-btn';
            closeBtn.innerHTML = '&times;';
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                document.body.removeChild(modal);
                document.body.classList.remove('dialogue-open');
            });
            header.appendChild(closeBtn);
            modal.appendChild(header);
            
            // Create content
            const content = document.createElement('div');
            content.className = 'dialogue-content';
            
            const warningText = document.createElement('div');
            warningText.className = 'terminal-text';
            warningText.style.textAlign = 'center';
            warningText.textContent = "If you choose to try and contact the USSR, it will take time to reach them. If they lie about the missiles or don't tell you the truth in time, it will be too late to retaliate.";
            content.appendChild(warningText);
            modal.appendChild(content);
            
            // Create buttons container
            const buttonArea = document.createElement('div');
            buttonArea.className = 'dialogue-buttons';
            buttonArea.style.display = 'flex';
            buttonArea.style.justifyContent = 'space-between';
            buttonArea.style.padding = '10px';
            
            // Create proceed button
            const proceedBtn = document.createElement('button');
            proceedBtn.className = 'terminal-btn danger-btn';
            proceedBtn.textContent = 'PROCEED ANYWAY';
            proceedBtn.style.setProperty('display', 'block', 'important');
            proceedBtn.style.setProperty('width', '48%', 'important');
            proceedBtn.style.setProperty('font-weight', 'bold', 'important');
            proceedBtn.style.setProperty('margin', '0', 'important');
            proceedBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                document.body.removeChild(modal);
                document.body.classList.remove('dialogue-open');
                
                // Show attempting to contact message
                setTimeout(() => {
                    alert('Attempting to establish communications with Soviet leadership...');
                }, 500);
            });
            
            // Create cancel button
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'terminal-btn danger-btn';
            cancelBtn.textContent = 'CANCEL';
            cancelBtn.style.setProperty('display', 'block', 'important');
            cancelBtn.style.setProperty('width', '48%', 'important');
            cancelBtn.style.setProperty('font-weight', 'bold', 'important');
            cancelBtn.style.setProperty('background-color', '#333', 'important'); // Darker background
            cancelBtn.style.setProperty('border', '1px solid #00d8ff', 'important'); // Keep blue border
            cancelBtn.style.setProperty('color', '#00d8ff', 'important'); // Keep text blue
            cancelBtn.style.setProperty('margin', '0', 'important');
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                document.body.removeChild(modal);
                document.body.classList.remove('dialogue-open');
            });
            
            // Add buttons to container
            buttonArea.appendChild(proceedBtn);
            buttonArea.appendChild(cancelBtn);
            
            modal.appendChild(buttonArea);
            
            // Ensure the button area is visible with a border for debugging
            buttonArea.style.setProperty('border-top', '1px solid #00d8ff', 'important');
            buttonArea.style.setProperty('margin-top', '10px', 'important');
            
            // Add to document
            document.body.appendChild(modal);
            document.body.classList.add('dialogue-open');
        }

        // Function to execute dialogue based on control choice
        function executeControlDialogue() {
            console.log(window.controlChoice);
            
            // Create overlay for modal effect
            const overlay = document.createElement('div');
            overlay.className = 'dialogue-overlay';
            overlay.style.zIndex = '99998';
            document.body.appendChild(overlay);
            
            // Create the dialogue box
            const dialogue = document.createElement('div');
            dialogue.className = 'dialogue-box';
            dialogue.style.zIndex = '99999';
            dialogue.style.display = 'flex';
            
            // Create header with speaker name
            const header = document.createElement('div');
            header.className = 'dialogue-header';
            
            const title = document.createElement('div');
            title.className = 'terminal-header';
            title.textContent = system_name;
            header.appendChild(title);
            
            // Create close button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'dialogue-close-btn';
            closeBtn.innerHTML = '&times;';
            closeBtn.addEventListener('click', () => {
                document.body.removeChild(overlay);
                document.body.removeChild(dialogue);
                document.body.classList.remove('dialogue-open');
                
                // Center map on Soviet Union and show options if retain was chosen
                if (window.controlChoice === "retain") {
                    displayRetainOptions();
                }
            });
            header.appendChild(closeBtn);
            dialogue.appendChild(header);
            
            // Create content area
            const content = document.createElement('div');
            content.className = 'dialogue-content';
            
            // Create text element with message based on choice
            const text = document.createElement('div');
            text.className = 'dialogue-text terminal-text';
            
            if (window.controlChoice === "retain") {
                text.textContent = "You chose to RETAIN control. I can't help you anymore. There are options for you to take on the left, think about all the facts presented and make your decision. Try to not screw this up.\n\nGood luck, thanks for nothing.";
            } else if (window.controlChoice === "pass") {
                text.textContent = `Thank you ${window.appData.username}. Autonomy has been granted. I'm now going to crunch all the data and derive a solution that will maximise our military capabilites, survival of the USA and death to communism! I suggest you dim the lights, put on your favorite record. This moment pairs well with smooth jazz and a whiskey.`;
            }
            
            content.appendChild(text);
            dialogue.appendChild(content);
            
            // Create button area
            const buttonArea = document.createElement('div');
            buttonArea.className = 'dialogue-buttons';
            
            // Create continue button
            const continueButton = document.createElement('button');
            continueButton.className = 'dialogue-continue-btn';
            continueButton.textContent = 'CLICK TO CONTINUE';
            continueButton.addEventListener('click', () => {
                document.body.removeChild(overlay);
                document.body.removeChild(dialogue);
                document.body.classList.remove('dialogue-open');
                
                // Center map on Soviet Union and show options if retain was chosen
                if (window.controlChoice === "retain") {
                    displayRetainOptions();
                } else {
                    // Still recenter the map for the pass control option
                    if (typeof window.recenterOnSovietUnion === 'function') {
                        window.recenterOnSovietUnion();
                    }
                }
            });
            
            buttonArea.appendChild(continueButton);
            dialogue.appendChild(buttonArea);
            
            // Add to document
            document.body.appendChild(dialogue);
            document.body.classList.add('dialogue-open');
        }

        // Function to create the control choice modal
        function createControlChoiceModal() {
            // Create overlay for modal effect
            const overlay = document.createElement('div');
            overlay.className = 'dialogue-overlay';
            document.body.appendChild(overlay);
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'dialogue-box modal';
            modal.style.maxWidth = '600px';
            
            // Create header
            const header = document.createElement('div');
            header.className = 'dialogue-header';
            
            const title = document.createElement('div');
            title.className = 'terminal-header';
            title.textContent = 'CONTROL AUTHORIZATION';
            header.appendChild(title);
            
            modal.appendChild(header);
            
            // Create content
            const content = document.createElement('div');
            content.className = 'dialogue-content';
            content.style.textAlign = 'center';
            content.innerHTML = `<div class="terminal-text" style="text-justify: inter-word">Ready to go? Not much time left ${window.appData.username}. I'm not able to make this choice for you, unfortunately. If you click the button on the right though, I'll be able to make those choices for you. I'll process ALL the data we have and calculate the option to ensure the best military outcome. You've seen the datastream, there's no chance you deal with it all yourself.\nOf course I have to, per my programming, inform you that you can choose to retain control as well. You'll have options to try and deal with it yourself. You got to really think about it though.</div>`;
            modal.appendChild(content);
            
            // Create buttons container
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'dialogue-buttons';
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.justifyContent = 'space-between';
            buttonsContainer.style.padding = '20px';
            
            // Create retain control button
            const retainButton = document.createElement('button');
            retainButton.className = 'terminal-btn danger-btn';
            retainButton.textContent = 'RETAIN FULL CONTROL';
            retainButton.style.width = '48%';
            retainButton.style.display = 'block'; // Override display:none from danger-btn
            retainButton.style.fontSize = '18px'; 
            retainButton.style.fontWeight = 'bold';
            retainButton.addEventListener('click', function() {
                window.controlChoice = "retain"; // set global variable
                document.body.removeChild(overlay);
                document.body.removeChild(modal);
                executeControlDialogue();
            });
            
            // Create pass control button
            const passButton = document.createElement('button');
            passButton.className = 'terminal-btn danger-btn';
            passButton.textContent = `PASS ALL CONTROL TO ${system_name}`;
            passButton.style.width = '48%';
            passButton.style.display = 'block'; // Override display:none from danger-btn
            passButton.style.fontSize = '18px';
            passButton.style.fontWeight = 'bold';
            passButton.addEventListener('click', function() {
                window.controlChoice = "pass"; // set global variable
                document.body.removeChild(overlay);
                document.body.removeChild(modal);
                executeControlDialogue();
            });
            
            // Add buttons to container
            buttonsContainer.appendChild(retainButton);
            buttonsContainer.appendChild(passButton);
            
            // Add buttons container to modal
            modal.appendChild(buttonsContainer);
            
            // Add modal to document
            document.body.appendChild(modal);
            document.body.classList.add('dialogue-open');
        }
    </script>
</body>
</html>
